!function(){"use strict";var e={737:function(e,t,n){var o,r=this&&this.__extends||(o=function(e,t){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},o(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),i=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return a(t,e),t},l=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var c=l(n(771)),u=s(n(61)),d=s(n(363)),h=function(e){function t(t){var n=e.call(this,t)||this;return n._drawShader=d.buildDrawShader(t),n.thickness=2,n}return r(t,e),t.prototype.freeGLResources=function(){this._drawShader.freeGLResources()},t.prototype.draw=function(){var t=e.prototype.gl.call(this),n=t.canvas,o=[n.clientWidth,n.clientHeight],r=this._drawShader;r.use();var i=[u.brush.radius/o[0],u.brush.radius/o[1]];r.u.uBrushSize.value=i,r.u.uBrushPos.value=u.mouse.pos,r.u.uThickness.value=this.thickness/u.brush.radius,r.bindUniformsAndAttributes(),t.drawArrays(t.TRIANGLE_STRIP,0,4)},t}(c.default);t.default=h},608:function(e,t){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.DynamicObstacleController=void 0;var o=function(){function e(e,t){this.controlPanel=null,this.obstacleMap=e,this.mouseRenderer=t,this.config={enabled:!1,autoCreate:!1,maxObstacles:10,defaultMass:1,defaultFriction:.95,defaultRestitution:.8,defaultSize:[.06,.06]},this.createControlPanel()}return e.prototype.setEnabled=function(e){this.config.enabled=e,e||(this.obstacleMap.clearDynamicObstacles(),this.mouseRenderer.updateDynamicObstacles([])),this.updateControlPanel()},e.prototype.isEnabled=function(){return this.config.enabled},e.prototype.addObstacle=function(e,t,n,o,r){if(!this.config.enabled)return console.warn("動態障礙物系統未啟用"),null;if(this.obstacleMap.getDynamicObstacles().length>=this.config.maxObstacles)return console.warn("已達到最大障礙物數量限制: ".concat(this.config.maxObstacles)),null;var i=e||[.6*Math.random()+.2,.6*Math.random()+.2],a=t||this.config.defaultSize,s=void 0!==n?n:this.config.defaultMass,l=void 0!==o?o:this.config.defaultFriction,c=void 0!==r?r:this.config.defaultRestitution,u=this.obstacleMap.createDynamicObstacle(i,a,s,l,c);return this.mouseRenderer.updateDynamicObstacles(this.obstacleMap.getDynamicObstacles()),this.updateControlPanel(),console.log("創建動態障礙物 ID: ".concat(u.id)),u},e.prototype.removeObstacle=function(e){if(this.config.enabled){var t=this.obstacleMap.getDynamicObstacles().find((function(t){return t.id===e}));t&&(this.obstacleMap.getDynamicObstacles().splice(this.obstacleMap.getDynamicObstacles().indexOf(t),1),this.mouseRenderer.updateDynamicObstacles(this.obstacleMap.getDynamicObstacles()),this.updateControlPanel(),console.log("移除動態障礙物 ID: ".concat(e)))}},e.prototype.clearAllObstacles=function(){this.obstacleMap.clearDynamicObstacles(),this.mouseRenderer.updateDynamicObstacles([]),this.updateControlPanel(),console.log("清除所有動態障礙物")},e.prototype.updateConfig=function(e){this.config=n(n({},this.config),e),this.updateControlPanel()},e.prototype.getConfig=function(){return n({},this.config)},e.prototype.createControlPanel=function(){this.controlPanel=document.createElement("div"),this.controlPanel.id="dynamic-obstacle-control",this.controlPanel.style.cssText="\n      position: fixed;\n      top: 10px;\n      right: 10px;\n      background: rgba(0, 0, 0, 0.8);\n      color: white;\n      padding: 15px;\n      border-radius: 8px;\n      font-family: Arial, sans-serif;\n      font-size: 12px;\n      z-index: 1000;\n      min-width: 200px;\n    ",this.updateControlPanel(),document.body.appendChild(this.controlPanel)},e.prototype.updateControlPanel=function(){if(this.controlPanel){var e=this.obstacleMap.getDynamicObstacles();this.controlPanel.innerHTML='\n      <h3 style="margin: 0 0 10px 0; color: #fff;">動態障礙物控制</h3>\n      \n      <div style="margin-bottom: 10px;">\n        <label>\n          <input type="checkbox" id="enableToggle" '.concat(this.config.enabled?"checked":"",">\n          啟用動態障礙物\n        </label>\n      </div>\n      \n      ").concat(this.config.enabled?'\n        <div style="border-top: 1px solid #666; padding-top: 10px;">\n          <div style="margin-bottom: 8px;">\n            <label>最大數量: \n              <input type="number" id="maxObstacles" value="'.concat(this.config.maxObstacles,'" \n                     min="1" max="50" style="width: 50px;">\n            </label>\n          </div>\n          \n          <div style="margin-bottom: 8px;">\n            <label>預設質量: \n              <input type="number" id="defaultMass" value="').concat(this.config.defaultMass,'" \n                     min="0.1" max="10" step="0.1" style="width: 50px;">\n            </label>\n          </div>\n          \n          <div style="margin-bottom: 8px;">\n            <label>摩擦係數: \n              <input type="number" id="defaultFriction" value="').concat(this.config.defaultFriction,'" \n                     min="0" max="1" step="0.05" style="width: 50px;">\n            </label>\n          </div>\n          \n          <div style="margin-bottom: 8px;">\n            <label>彈性係數: \n              <input type="number" id="defaultRestitution" value="').concat(this.config.defaultRestitution,'" \n                     min="0" max="1" step="0.1" style="width: 50px;">\n            </label>\n          </div>\n          \n          <div style="margin: 10px 0;">\n            <button id="addObstacle" style="padding: 5px 10px; margin-right: 5px;">\n              添加障礙物\n            </button>\n            <button id="clearObstacles" style="padding: 5px 10px;">\n              清除全部\n            </button>\n          </div>\n          \n          <div style="border-top: 1px solid #666; padding-top: 8px; font-size: 11px;">\n            <div>當前障礙物: ').concat(e.length,"/").concat(this.config.maxObstacles,"</div>\n            ").concat(e.length>0?'\n              <div style="max-height: 100px; overflow-y: auto; margin-top: 5px;">\n                '.concat(e.map((function(e){return'\n                  <div style="display: flex; justify-content: space-between; align-items: center; margin: 2px 0;">\n                    <span>ID '.concat(e.id," (M:").concat(e.mass.toFixed(1),')</span>\n                    <button onclick="window.dynamicObstacleController?.removeObstacle(').concat(e.id,')" \n                            style="padding: 1px 5px; font-size: 10px;">移除</button>\n                  </div>\n                ')})).join(""),"\n              </div>\n            "):"","\n          </div>\n        </div>\n      "):"","\n    "),this.bindControlEvents()}},e.prototype.bindControlEvents=function(){var e=this;if(this.controlPanel){var t=this.controlPanel.querySelector("#enableToggle");t&&t.addEventListener("change",(function(t){e.setEnabled(t.target.checked)})),["maxObstacles","defaultMass","defaultFriction","defaultRestitution"].forEach((function(t){var n=e.controlPanel.querySelector("#".concat(t));n&&n.addEventListener("change",(function(){var o=parseFloat(n.value);"maxObstacles"===t?e.config.maxObstacles=o:"defaultMass"===t?e.config.defaultMass=o:"defaultFriction"===t?e.config.defaultFriction=o:"defaultRestitution"===t&&(e.config.defaultRestitution=o)}))}));var n=this.controlPanel.querySelector("#addObstacle");n&&n.addEventListener("click",(function(){e.addObstacle()}));var o=this.controlPanel.querySelector("#clearObstacles");o&&o.addEventListener("click",(function(){e.clearAllObstacles()})),window.dynamicObstacleController=this}},e.prototype.update=function(e,t){this.config.enabled&&(this.obstacleMap.updateDynamicObstacles(e,t),this.mouseRenderer.updateDynamicObstacles(this.obstacleMap.getDynamicObstacles()))},e.prototype.destroy=function(){this.controlPanel&&this.controlPanel.parentElement&&this.controlPanel.parentElement.removeChild(this.controlPanel),delete window.dynamicObstacleController},e}();t.DynamicObstacleController=o},556:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.DynamicObstacleSystem=void 0;var n=function(){function e(e,t){this.obstacles=[],this.nextId=0,this.canvasWidth=e,this.canvasHeight=t}return e.prototype.createObstacle=function(e,t,n,o,r){void 0===t&&(t=[.02,.02]),void 0===n&&(n=1),void 0===o&&(o=.95),void 0===r&&(r=.8);var i={pos:e,vel:[0,0],size:t,mass:n,friction:o,restitution:r,id:this.nextId++};return this.obstacles.push(i),i},e.prototype.checkPointObstacleCollision=function(e,t){var n=e.pos[0]-t.pos[0],o=e.pos[1]-t.pos[1],r=Math.sqrt(n*n+o*o),i=.5*(t.size[0]+t.size[1]),a=.01+i,s=r<a;return s&&console.log("🔥 碰撞檢測成功! \n        點位置: [".concat(e.pos[0].toFixed(3),", ").concat(e.pos[1].toFixed(3),"]\n        障礙物位置: [").concat(t.pos[0].toFixed(3),", ").concat(t.pos[1].toFixed(3),"]\n        距離: ").concat(r.toFixed(4),"\n        碰撞閾值: ").concat(a.toFixed(4),"\n        點半徑: ").concat(.01,", 障礙物半徑: ").concat(i.toFixed(4))),s},e.prototype.handlePointObstacleCollision=function(e,t){var n=e.pos[0]-t.pos[0],o=e.pos[1]-t.pos[1],r=Math.sqrt(n*n+o*o);if(console.log("⚡ 處理碰撞: 距離=".concat(r.toFixed(4),", 點移動:[").concat(e.movement[0].toFixed(3),", ").concat(e.movement[1].toFixed(3),"], 障礙物速度:[").concat(t.vel[0].toFixed(3),", ").concat(t.vel[1].toFixed(3),"]")),0!==r){var i=n/r,a=o/r,s=(e.movement[0]-t.vel[0])*i+(e.movement[1]-t.vel[1])*a;if(!(s>0)){var l=-(1+t.restitution)*s/(10+1/t.mass),c=l*i,u=l*a;t.vel[0]+=c/t.mass,t.vel[1]+=u/t.mass;var d=.01+.5*(t.size[0]+t.size[1])-r;if(d>0){var h=i*d*.5,p=a*d*.5;t.pos[0]-=h,t.pos[1]-=p}}}},e.prototype.handleBoundaryCollision=function(e){var t=.5*e.size[0],n=.5*e.size[1];e.pos[0]-t<0?(e.pos[0]=t,e.vel[0]=-e.vel[0]*e.restitution):e.pos[0]+t>1&&(e.pos[0]=1-t,e.vel[0]=-e.vel[0]*e.restitution),e.pos[1]-n<0?(e.pos[1]=n,e.vel[1]=-e.vel[1]*e.restitution):e.pos[1]+n>1&&(e.pos[1]=1-n,e.vel[1]=-e.vel[1]*e.restitution)},e.prototype.handleObstacleCollisions=function(){for(var e=0;e<this.obstacles.length;e++)for(var t=e+1;t<this.obstacles.length;t++){var n=this.obstacles[e],o=this.obstacles[t],r=o.pos[0]-n.pos[0],i=o.pos[1]-n.pos[1],a=Math.sqrt(r*r+i*i),s=.5*(n.size[0]+n.size[1])+.5*(o.size[0]+o.size[1]);if(a<s&&a>0){var l=r/a,c=i/a,u=(o.vel[0]-n.vel[0])*l+(o.vel[1]-n.vel[1])*c;if(u>0)continue;var d=-(1+Math.min(n.restitution,o.restitution))*u/(1/n.mass+1/o.mass),h=d*l,p=d*c;n.vel[0]-=h/n.mass,n.vel[1]-=p/n.mass,o.vel[0]+=h/o.mass,o.vel[1]+=p/o.mass;var v=s-a,f=l*v*.5,b=c*v*.5;n.pos[0]-=f,n.pos[1]-=b,o.pos[0]+=f,o.pos[1]+=b}}},e.prototype.update=function(e,t){for(var n=0,o=e;n<o.length;n++)for(var r=o[n],i=0,a=this.obstacles;i<a.length;i++){var s=a[i];this.checkPointObstacleCollision(r,s)&&(console.log("🚨 WS點碰撞檢測成功! 點位置:[".concat(r.pos[0].toFixed(3),", ").concat(r.pos[1].toFixed(3),"], 障礙物位置:[").concat(s.pos[0].toFixed(3),", ").concat(s.pos[1].toFixed(3),"], ID:").concat(s.id)),this.handlePointObstacleCollision(r,s))}for(var l=0,c=this.obstacles;l<c.length;l++)(s=c[l]).vel[0]*=s.friction,s.vel[1]*=s.friction,s.pos[0]+=s.vel[0]*t,s.pos[1]+=s.vel[1]*t,this.handleBoundaryCollision(s);this.handleObstacleCollisions()},e.prototype.getObstacles=function(){return this.obstacles},e.prototype.removeObstacle=function(e){this.obstacles=this.obstacles.filter((function(t){return t.id!==e}))},e.prototype.clear=function(){this.obstacles=[]},e.prototype.updateCanvasSize=function(e,t){this.canvasWidth=e,this.canvasHeight=t},e}();t.DynamicObstacleSystem=n},850:function(e,t,n){var o,r=this&&this.__extends||(o=function(e,t){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},o(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),i=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return a(t,e),t},l=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var c=l(n(771)),u=l(n(72)),d=s(n(61)),h=s(n(916));n(457);var p=function(e){function t(t,n,o){var r=e.call(this,t)||this;return r._useFloatTextures=!1,r.viscosity=2e-4,r.colorIntensity=.033,r.color=!0,r.reset(n,o),r}return r(t,e),t.prototype.freeGLResources=function(){this._FBO&&this._FBO.freeGLResources(),this.freeTextures(),this.freeShaders()},t.prototype.freeTextures=function(){var t=e.prototype.gl.call(this);this._velTextures&&(t.deleteTexture(this._velTextures[0]),t.deleteTexture(this._velTextures[1])),t.deleteTexture(this._tmpTexture),t.deleteTexture(this._pressureTexture),t.deleteTexture(this._divergenceTexture)},t.prototype.freeShaders=function(){function e(e){e&&e.freeGLResources()}e(this._drawVelocityShader),e(this._drawPressureShader),e(this._addVelShader),e(this._advectShader),e(this._jacobiPressureShader),e(this._divergenceShader),e(this._substractGradientShader),e(this._obstaclesVelocityShader)},t.prototype.reset=function(t,n){this.freeGLResources(),this._width=t,this._height=n,this.dx=1/Math.min(t,n),this._FBO=new u.default(e.prototype.gl.call(this),t,n),this.initTextures(),this.buildShaders(),this._currIndex=0},Object.defineProperty(t.prototype,"useFloatTextures",{set:function(e){e!==this._useFloatTextures&&(this._useFloatTextures=e,this.reset(this._width,this._height))},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"minNbIterations",{set:function(e){this._nbIterations=2*Math.ceil(e/2)+1},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"texelSize",{get:function(){return[1/this._width,1/this._height]},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"velTexture",{get:function(){return this._velTextures[this.currIndex]},enumerable:!1,configurable:!0}),t.prototype.update=function(t){var n=e.prototype.gl.call(this),o=this.timestep;n.clearColor(.5,0,.5,0);for(var r=window.multiMousePoints||[],i=n.canvas,a=[i.clientWidth,i.clientHeight],s=[d.brush.radius/a[0],d.brush.radius/a[1]],l=0,c=r;l<c.length;l++){var u=c[l],h=u.pos,p=[u.movement[0]*d.brush.strength,u.movement[1]*d.brush.strength];this.addVel(h,s,p)}this.advect(o),this.obstaclesVelocity(t),this.project(t),this.obstaclesVelocity(t)},t.prototype.addVel=function(e,t,n){var o=this.gl(),r=this._addVelShader;r.u.uVel.value=this._velTextures[this.currIndex],r.u.uBrushPos.value=e,r.u.uBrushSize.value=t,r.u.uAddVel.value=n,r.use(),this._FBO.bind([this._velTextures[this.nextIndex]]),r.bindUniformsAndAttributes(),o.drawArrays(o.TRIANGLE_STRIP,0,4),this.switchBuffers()},t.prototype.drawVelocity=function(){var e=this.gl(),t=this._drawVelocityShader;t.u.uVel.value=this._velTextures[this.currIndex],t.u.uColorIntensity.value=this.colorIntensity,t.u.uBlacknWhite.value=!this.color,t.use(),t.bindUniformsAndAttributes(),e.drawArrays(e.TRIANGLE_STRIP,0,4)},t.prototype.drawPressure=function(){var e=this.gl(),t=this._drawPressureShader;t.u.uPressure.value=this._pressureTexture,t.u.uColorIntensity.value=this.colorIntensity,t.u.uBlacknWhite.value=!this.color,t.use(),t.bindUniformsAndAttributes(),e.drawArrays(e.TRIANGLE_STRIP,0,4)},Object.defineProperty(t.prototype,"currIndex",{get:function(){return this._currIndex},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"nextIndex",{get:function(){return(this._currIndex+1)%2},enumerable:!1,configurable:!0}),t.prototype.switchBuffers=function(){this._currIndex=this.nextIndex},t.prototype.obstaclesVelocity=function(e){var t=this.gl(),n=this._obstaclesVelocityShader;n.u.uVelocities.value=this._velTextures[this.currIndex],n.u.uObstacles.value=e.texture,n.u.uTexelSize.value=this.texelSize,this._FBO.bind([this._velTextures[this.nextIndex]]),n.use(),n.bindUniformsAndAttributes(),t.drawArrays(t.TRIANGLE_STRIP,0,4),this.switchBuffers()},t.prototype.advect=function(e){var t=this.gl(),n=this._advectShader;n.u.uVelUnit.value=[128/this._width,128/this._height],n.u.uDt.value=e,n.u.uQuantity.value=this._velTextures[this.currIndex],n.u.uVel.value=this._velTextures[this.currIndex],this._FBO.bind([this._velTextures[this.nextIndex]]),n.use(),n.bindUniformsAndAttributes(),t.drawArrays(t.TRIANGLE_STRIP,0,4),this.switchBuffers()},t.prototype.computeDivergence=function(){var e=this.gl(),t=this._divergenceShader;t.u.uTexelSize.value=this.texelSize,t.u.uVelocity.value=this._velTextures[this.currIndex],this._FBO.bind([this._divergenceTexture]),e.clear(e.COLOR_BUFFER_BIT),t.use(),t.bindUniformsAndAttributes(),e.drawArrays(e.TRIANGLE_STRIP,0,4)},t.prototype.computePressure=function(e){var t=this.gl(),n=this._jacobiPressureShader,o=-.5*this.dx,r=this._pressureTexture,i=this._divergenceTexture;n.u.uTexelSize.value=this.texelSize,n.u.uAlpha.value=o,n.u.uInvBeta.value=1/4,n.u.uConstantTerm.value=i,n.u.uObstacles.value=e.texture;var a=0,s=[this._tmpTexture,r];this._FBO.bind([this._tmpTexture]),t.clear(t.COLOR_BUFFER_BIT),n.use(),n.bindAttributes();for(var l=0;l<this._nbIterations;++l)n.u.uPrevIter.value=s[a],this._FBO.bind([s[(a+1)%2]]),n.bindUniforms(),t.drawArrays(t.TRIANGLE_STRIP,0,4),a=(a+1)%2},t.prototype.substractPressureGradient=function(){var e=this.gl(),t=this._substractGradientShader;t.u.uVelocities.value=this._velTextures[this.currIndex],t.u.uPressure.value=this._pressureTexture,t.u.uTexelSize.value=this.texelSize,t.u.uHalfInvDx.value=.5/this.dx,this._FBO.bind([this._velTextures[this.nextIndex]]),t.use(),t.bindUniformsAndAttributes(),e.drawArrays(e.TRIANGLE_STRIP,0,4),this.switchBuffers()},t.prototype.project=function(e){this.computeDivergence(),this.computePressure(e),this.substractPressureGradient()},t.prototype.initTextures=function(){this.freeTextures();for(var t=e.prototype.gl.call(this),n=this._width,o=this._height,r=[],i=0;i<4*n*o;++i)r.push(0);var a=new Float32Array(r),s=[];for(i=0;i<4*n*o;++i)s.push(127);var l=new Uint8Array(s),c=this._useFloatTextures?t.FLOAT:t.UNSIGNED_BYTE,u=this._useFloatTextures?a:l,d=[];for(i=0;i<2;++i){var h=t.createTexture();t.bindTexture(t.TEXTURE_2D,h),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,n,o,0,t.RGBA,c,u),d.push(h)}for(i=0;i<3;++i)h=t.createTexture(),t.bindTexture(t.TEXTURE_2D,h),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,n,o,0,t.RGBA,t.UNSIGNED_BYTE,l),d.push(h);for(var p=0,v=d;p<v.length;p++)h=v[p],t.bindTexture(t.TEXTURE_2D,h),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);t.bindTexture(t.TEXTURE_2D,null),this._velTextures=[d[0],d[1]],this._tmpTexture=d[2],this._pressureTexture=d[3],this._divergenceTexture=d[4]},t.prototype.buildShaders=function(){this.freeShaders(),h.setUseFloatTextures(this._useFloatTextures);var t=e.prototype.gl.call(this);this._drawVelocityShader=h.buildDrawVelocityShader(t),this._drawPressureShader=h.buildDrawPressureShader(t),this._addVelShader=h.buildAddVelShader(t),this._advectShader=h.buildAdvectShader(t),this._jacobiPressureShader=h.buildJacobiPressureShader(t),this._divergenceShader=h.buildDivergenceShader(t),this._substractGradientShader=h.buildSubstractGradientShader(t),this._obstaclesVelocityShader=h.buildObstaclesVelocityShader(t)},t}(c.default);t.default=p},72:function(e,t,n){var o,r=this&&this.__extends||(o=function(e,t){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},o(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(t,n,o){var r=e.call(this,t)||this;return r.id=t.createFramebuffer(),r.width=n,r.height=o,r}return r(t,e),t.prototype.bind=function(t,n){void 0===n&&(n=null);var o=e.prototype.gl.call(this);o.bindFramebuffer(o.FRAMEBUFFER,this.id),o.viewport(0,0,this.width,this.height);for(var r=0;r<t.length;++r)o.framebufferTexture2D(o.FRAMEBUFFER,o["COLOR_ATTACHMENT"+r],o.TEXTURE_2D,t[r],0);n&&(o.bindRenderbuffer(o.RENDERBUFFER,n),o.framebufferRenderbuffer(o.FRAMEBUFFER,o.DEPTH_ATTACHMENT,o.RENDERBUFFER,n))},t.bindDefault=function(e){e.bindFramebuffer(e.FRAMEBUFFER,null),e.viewport(0,0,e.drawingBufferWidth,e.drawingBufferHeight)},t.prototype.freeGLResources=function(){e.prototype.gl.call(this).deleteFramebuffer(this.id),this.id=null},t}(i(n(771)).default);t.default=a},771:function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=function(){function e(e){this._gl=e}return e.prototype.gl=function(){return this._gl},e}();t.default=n},490:function(e,t,n){var o,r=this&&this.__extends||(o=function(e,t){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},o(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var a=i(n(771));function s(e,t,n){alert("NOT IMPLEMENTED YET")}var l={35664:{str:"FLOAT_VEC2",binder:function(e,t,n){e.uniform2fv(t,n)}},35665:{str:"FLOAT_VEC3",binder:function(e,t,n){e.uniform3fv(t,n)}},35666:{str:"FLOAT_VEC4",binder:function(e,t,n){e.uniform4fv(t,n)}},35667:{str:"INT_VEC2",binder:function(e,t,n){e.uniform2iv(t,n)}},35668:{str:"INT_VEC3",binder:function(e,t,n){e.uniform3iv(t,n)}},35669:{str:"INT_VEC4",binder:function(e,t,n){e.uniform4iv(t,n)}},35670:{str:"BOOL",binder:function(e,t,n){e.uniform1i(t,+n)}},35671:{str:"BOOL_VEC2",binder:function(e,t,n){e.uniform2iv(t,n)}},35672:{str:"BOOL_VEC3",binder:function(e,t,n){e.uniform3iv(t,n)}},35673:{str:"BOOL_VEC4",binder:function(e,t,n){e.uniform4iv(t,n)}},35674:{str:"FLOAT_MAT2",binder:function(e,t,n){e.uniformMatrix2fv(t,!1,n)}},35675:{str:"FLOAT_MAT3",binder:function(e,t,n){e.uniformMatrix3fv(t,!1,n)}},35676:{str:"FLOAT_MAT4",binder:function(e,t,n){e.uniformMatrix4fv(t,!1,n)}},35678:{str:"SAMPLER_2D",binder:function(e,t,n,o){e.uniform1i(t,n),e.activeTexture(e["TEXTURE"+n]),e.bindTexture(e.TEXTURE_2D,o)}},35680:{str:"SAMPLER_CUBE",binder:function(e,t,n,o){e.uniform1i(t,n),e.activeTexture(e["TEXTURE"+n]),e.bindTexture(e.TEXTURE_CUBE_MAP,o)}},5120:{str:"BYTE",binder:s},5121:{str:"UNSIGNED_BYTE",binder:s},5122:{str:"SHORT",binder:s},5123:{str:"UNSIGNED_SHORT",binder:s},5124:{str:"INT",binder:function(e,t,n){Array.isArray(n),e.uniform1iv(t,n)}},5125:{str:"UNSIGNED_INT",binder:s},5126:{str:"FLOAT",binder:function(e,t,n){Array.isArray(n)?e.uniform1fv(t,n):e.uniform1f(t,n)}}},c=function(e){function t(t,n,o){var r=this;function i(e,n){var o=t.createShader(e);return t.shaderSource(o,n),t.compileShader(o),t.getShaderParameter(o,t.COMPILE_STATUS)?o:(console.log(t.getShaderInfoLog(o)),t.deleteShader(o),null)}(r=e.call(this,t)||this).id=null,r.uCount=0,r.aCount=0;var a=i(t.VERTEX_SHADER,n),s=i(t.FRAGMENT_SHADER,o),l=t.createProgram();return t.attachShader(l,a),t.attachShader(l,s),t.linkProgram(l),t.getProgramParameter(l,t.LINK_STATUS)?(r.id=l,r.introspection()):(console.log(t.getProgramInfoLog(l)),t.deleteProgram(l)),r}return r(t,e),t.prototype.freeGLResources=function(){e.prototype.gl.call(this).deleteProgram(this.id),this.id=null},t.prototype.introspection=function(){var t=e.prototype.gl.call(this);this.uCount=t.getProgramParameter(this.id,t.ACTIVE_UNIFORMS),this.u=[];for(var n=0;n<this.uCount;++n){var o=t.getActiveUniform(this.id,n),r=o.name;this.u[r]={value:null,loc:t.getUniformLocation(this.id,r),size:o.size,type:o.type}}for(this.aCount=t.getProgramParameter(this.id,t.ACTIVE_ATTRIBUTES),this.a=[],n=0;n<this.aCount;++n){var i=t.getActiveAttrib(this.id,n),a=i.name;this.a[a]={VBO:null,loc:t.getAttribLocation(this.id,a),size:i.size,type:i.type}}},t.prototype.use=function(){e.prototype.gl.call(this).useProgram(this.id)},t.prototype.bindUniforms=function(){var t=e.prototype.gl.call(this),n=0;for(var o in this.u){var r=this.u[o];if(null!==r.value)if(35678===r.type||35680===r.type){var i=n;l[r.type].binder(t,r.loc,i,r.value),n++}else l[r.type].binder(t,r.loc,r.value)}},t.prototype.bindAttributes=function(){for(var e in this.a){var t=this.a[e];null!==t.VBO&&t.VBO.bind(t.loc)}},t.prototype.bindUniformsAndAttributes=function(){this.bindUniforms(),this.bindAttributes()},t}(a.default);t.default=c},548:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.resizeCanvas=void 0,t.resizeCanvas=function(e,t){void 0===t&&(t=!1);var n=t?window.devicePixelRatio:1,o=e.canvas,r=Math.floor(o.clientWidth*n),i=Math.floor(o.clientHeight*n);o.width==r&&o.height==i||(o.width=r,o.height=i)}},62:function(e,t,n){var o,r=this&&this.__extends||(o=function(e,t){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},o(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var a=function(e){function t(t,n,o,r){var i=e.call(this,t)||this;return i.id=t.createBuffer(),t.bindBuffer(t.ARRAY_BUFFER,i.id),t.bufferData(t.ARRAY_BUFFER,n,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,null),i.size=o,i.type=r,i.normalize=!1,i.stride=0,i.offset=0,i}return r(t,e),t.prototype.freeGLResources=function(){this.gl().deleteBuffer(this.id),this.id=null},t.createQuad=function(e,n,o,r,i){return new t(e,new Float32Array([n,o,r,o,n,i,r,i]),2,e.FLOAT)},t.prototype.bind=function(t){var n=e.prototype.gl.call(this);n.enableVertexAttribArray(t),n.bindBuffer(n.ARRAY_BUFFER,this.id),n.vertexAttribPointer(t,this.size,this.type,this.normalize,this.stride,this.offset)},t}(i(n(771)).default);t.default=a},633:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var s=i(n(548)),l=a(n(72)),c=i(n(61)),u=a(n(737)),d=a(n(980)),h=a(n(850)),p=i(n(761));n(457);var v=n(298),f=n(318),b=n(608),_=null,m=null;new v.MultiMouseWS("ws://localhost:9980",(function(e){window.multiMousePoints=e,_&&_.updatePoints(e)}),10).connect(),function(){var e=Page.Canvas.getCanvas();if(e){var t=function(e,t){function n(e){Page.Demopage.setErrorMessage("webgl-support",e)}var o=e.getContext("webgl",t);if(!o){if(!(o=e.getContext("experimental-webgl",t)))return n("Your browser or device does not seem to support WebGL."),null;n("Your browser or device only supports experimental WebGL.\nThe simulation may not run as expected.")}return o&&(e.style.cursor="none",o.disable(o.CULL_FACE),o.disable(o.DEPTH_TEST),o.disable(o.BLEND),o.clearColor(0,0,0,1),s.resizeCanvas(o,!1)),o}(e,{alpha:!1});if(t&&p.check(t)){var n=t;_=new f.MousePointRenderer(e),p.loadExtensions(n,["OES_texture_float","WEBGL_color_buffer_float","OES_texture_float_linear"]);var o=256,r=new h.default(n,o,o),i=new u.default(n),a=[];a.none=new d.default(n,o,o),a.one=new d.default(n,o,o),a.one.addObstacle([.015,.015],[.3,.5]),a.many=new d.default(n,o,o);for(var v=[.012,.012],y=0;y<5;++y)for(var g=-y/2;g<=y/2;++g){v=[v[0]+5e-4,v[1]+5e-4];var x=[.3+.07*y,.5+.08*g];a.many.addObstacle(v,x)}a.dynamic=new d.default(n,o,o),m=new b.DynamicObstacleController(a.dynamic,_),window.obstacleMaps=a,window.dynamicObstacleController=m,c.bind(r);var P=0;setInterval((function(){Page.Canvas.setIndicatorText("fps",P.toFixed(0))}),1e3);var O=0;requestAnimationFrame((function e(t){var o=(t*=.001)-O;P=1/o,O=t,o=Math.min(o,.1);var s=a[c.obstacles];if(m&&"dynamic"===c.obstacles){var u=window.multiMousePoints||[],d=a.dynamic.getDynamicObstacles().length;u.length>0&&(console.log("🎯 更新動態障礙物: 收到".concat(u.length,"個WS點, 當前有").concat(d,"個障礙物")),u.forEach((function(e,t){console.log("  點".concat(t,": 位置[").concat(e.pos[0].toFixed(3),", ").concat(e.pos[1].toFixed(3),"], 移動[").concat(e.movement[0].toFixed(3),", ").concat(e.movement[1].toFixed(3),"]"))})),a.dynamic.getDynamicObstacles().forEach((function(e,t){console.log("  障礙物".concat(t," (ID:").concat(e.id,"): 位置[").concat(e.pos[0].toFixed(3),", ").concat(e.pos[1].toFixed(3),"], 大小[").concat(e.size[0].toFixed(3),", ").concat(e.size[1].toFixed(3),"], 速度[").concat(e.vel[0].toFixed(3),", ").concat(e.vel[1].toFixed(3),"]"))}))),m.update(u,o),s.addDynamicObstacleVelocityToFluid(r)}c.fluid.stream&&r.addVel([.1,.5],[.05,.2],[.4,0]),r.update(s),l.default.bindDefault(n),n.clear(n.COLOR_BUFFER_BIT|n.DEPTH_BUFFER_BIT),c.display.velocity?r.drawVelocity():c.display.pressure&&r.drawPressure(),c.display.brush&&i.draw(),c.display.obstacles&&s.draw(),c.display.velocity&&c.display.pressure&&(n.viewport(10,10,128,128),r.drawPressure()),requestAnimationFrame(e)}))}}else console.error("Canvas element not found")}()},318:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.MousePointRenderer=void 0;var n=function(){function e(e){var t=this;this.points=[],this.dynamicObstacles=[],this.canvas=e,this.overlayCanvas=document.createElement("canvas"),this.overlayCanvas.style.position="absolute",this.overlayCanvas.style.top="0",this.overlayCanvas.style.left="0",this.overlayCanvas.style.pointerEvents="none",this.overlayCanvas.style.zIndex="10",this.updateCanvasSize(),this.canvas.parentElement&&(this.canvas.parentElement.appendChild(this.overlayCanvas),"static"===getComputedStyle(this.canvas.parentElement).position&&(this.canvas.parentElement.style.position="relative")),this.overlayCtx=this.overlayCanvas.getContext("2d"),new ResizeObserver((function(){t.updateCanvasSize()})).observe(this.canvas)}return e.prototype.updateCanvasSize=function(){var e=this.canvas.getBoundingClientRect();this.overlayCanvas.width=e.width,this.overlayCanvas.height=e.height,this.overlayCanvas.style.width=e.width+"px",this.overlayCanvas.style.height=e.height+"px"},e.prototype.updatePoints=function(e){this.points=e,this.render()},e.prototype.updateDynamicObstacles=function(e){this.dynamicObstacles=e,this.render()},e.prototype.render=function(){var e=this;this.overlayCtx.clearRect(0,0,this.overlayCanvas.width,this.overlayCanvas.height);var t=this.overlayCanvas.width,n=this.overlayCanvas.height;this.renderDynamicObstacles(t,n),0!==this.points.length&&this.points.forEach((function(o,r){var i=o.pos[0]*t,a=(1-o.pos[1])*n,s="hsl(".concat(137.5*r%360,", 70%, 60%)");e.drawPoint(i,a,s,r),0===o.movement[0]&&0===o.movement[1]||e.drawMovement(i,a,o.movement,s,t,n)}))},e.prototype.renderDynamicObstacles=function(e,t){var n=this;this.dynamicObstacles.forEach((function(o,r){var i=o.pos[0]*e,a=(1-o.pos[1])*t,s=o.size[0]*e,l=o.size[1]*t;n.drawObstacle(i,a,s,l,o,r),0===o.vel[0]&&0===o.vel[1]||n.drawObstacleVelocity(i,a,o.vel,e,t)}))},e.prototype.drawPoint=function(e,t,n,o){var r=this.overlayCtx;r.beginPath(),r.arc(e,t,12,0,2*Math.PI),r.fillStyle=n,r.globalAlpha=.7,r.fill(),r.beginPath(),r.arc(e,t,8,0,2*Math.PI),r.fillStyle="white",r.globalAlpha=.9,r.fill(),r.fillStyle="black",r.globalAlpha=1,r.font="12px Arial",r.textAlign="center",r.textBaseline="middle",r.fillText((o+1).toString(),e,t),r.globalAlpha=1},e.prototype.drawMovement=function(e,t,n,o,r,i){var a=this.overlayCtx,s=n[0]*r*100,l=n[1]*i*100,c=Math.sqrt(s*s+l*l);if(!(c<5)){var u=e+s,d=t+l;a.beginPath(),a.moveTo(e,t),a.lineTo(u,d),a.strokeStyle=o,a.lineWidth=2,a.globalAlpha=.8,a.stroke();var h=Math.atan2(l,s),p=Math.min(15,.3*c);a.beginPath(),a.moveTo(u,d),a.lineTo(u-p*Math.cos(h-Math.PI/6),d-p*Math.sin(h-Math.PI/6)),a.moveTo(u,d),a.lineTo(u-p*Math.cos(h+Math.PI/6),d-p*Math.sin(h+Math.PI/6)),a.stroke(),a.globalAlpha=1}},e.prototype.drawObstacle=function(e,t,n,o,r,i){var a=this.overlayCtx,s=(60*r.mass+120*r.friction)%360,l="hsl(".concat(s,", 80%, 50%)");a.beginPath(),a.ellipse(e,t,n/2,o/2,0,0,2*Math.PI),a.fillStyle=l,a.globalAlpha=.8,a.fill(),a.strokeStyle="white",a.lineWidth=2,a.globalAlpha=1,a.stroke(),a.fillStyle="white",a.font="10px Arial",a.textAlign="center",a.textBaseline="middle",a.fillText("O".concat(r.id),e,t),a.font="8px Arial",a.fillStyle="black",a.fillText("M:".concat(r.mass.toFixed(1)," F:").concat(r.friction.toFixed(2)," R:").concat(r.restitution.toFixed(2)),e,t+o/2+10)},e.prototype.drawObstacleVelocity=function(e,t,n,o,r){var i=this.overlayCtx,a=n[0]*o*200,s=-n[1]*r*200,l=Math.sqrt(a*a+s*s);if(!(l<3)){var c=e+a,u=t+s;i.beginPath(),i.moveTo(e,t),i.lineTo(c,u),i.strokeStyle="red",i.lineWidth=2,i.globalAlpha=.9,i.stroke();var d=Math.atan2(s,a),h=Math.min(12,.2*l);i.beginPath(),i.moveTo(c,u),i.lineTo(c-h*Math.cos(d-Math.PI/6),u-h*Math.sin(d-Math.PI/6)),i.moveTo(c,u),i.lineTo(c-h*Math.cos(d+Math.PI/6),u-h*Math.sin(d+Math.PI/6)),i.stroke(),i.globalAlpha=1}},e.prototype.destroy=function(){this.overlayCanvas.parentElement&&this.overlayCanvas.parentElement.removeChild(this.overlayCanvas)},e}();t.MousePointRenderer=n},980:function(e,t,n){var o,r=this&&this.__extends||(o=function(e,t){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},o(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}),i=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),a=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&i(t,e,n);return a(t,e),t},l=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var c=l(n(771)),u=l(n(72)),d=s(n(170)),h=n(556),p=function(e){function t(t,n,o){var r=e.call(this,t)||this;return r._width=n,r._height=o,r._fbo=new u.default(t,n,o),r._drawShader=d.buildDrawShader(t),r._addShader=d.buildAddShader(t),r._dynamicObstacleSystem=new h.DynamicObstacleSystem(n,o),r.initObstaclesMap(),console.log("🔧 ObstacleMap 初始化完成: 寬度=".concat(n,", 高度=").concat(o,", texture=").concat(r._texture?"OK":"FAILED")),r}return r(t,e),t.prototype.freeGLResources=function(){var t=e.prototype.gl.call(this);this._fbo.freeGLResources(),t.deleteTexture(this._texture),t.deleteTexture(this._initTexture),this._drawShader.freeGLResources(),this._addShader.freeGLResources()},Object.defineProperty(t.prototype,"texture",{get:function(){return this._texture||(console.error("🚨 ObstacleMap texture 未初始化！重新初始化..."),this.initObstaclesMap()),this._texture},enumerable:!1,configurable:!0}),t.prototype.draw=function(){var t=e.prototype.gl.call(this),n=this._drawShader;n.u.uObstacles.value=this.texture,n.use(),n.bindUniformsAndAttributes(),t.drawArrays(t.TRIANGLE_STRIP,0,4)},t.prototype.addObstacle=function(t,n){var o=e.prototype.gl.call(this),r=this._addShader;r.u.uSize.value=t,r.u.uPos.value=n,this._fbo.bind([this._texture]),r.use(),r.bindUniformsAndAttributes(),o.drawArrays(o.TRIANGLE_STRIP,0,4)},t.prototype.createDynamicObstacle=function(e,t,n,o,r){void 0===t&&(t=[.02,.02]),void 0===n&&(n=1),void 0===o&&(o=.95),void 0===r&&(r=.8);var i=this._dynamicObstacleSystem.createObstacle(e,t,n,o,r);return this.addObstacle(t,e),console.log("🎯 使用GPU创建动态障碍物 ID:".concat(i.id," 位置:[").concat(e[0].toFixed(3),", ").concat(e[1].toFixed(3),"] 大小:[").concat(t[0].toFixed(3),", ").concat(t[1].toFixed(3),"]")),i},t.prototype.updateDynamicObstacles=function(e,t){this._dynamicObstacleSystem.update(e,t),this.redrawAllDynamicObstacles()},t.prototype.getDynamicObstacles=function(){return this._dynamicObstacleSystem.getObstacles()},t.prototype.clearDynamicObstacles=function(){this._dynamicObstacleSystem.clear(),this.redrawAllDynamicObstacles()},t.prototype.redrawAllDynamicObstacles=function(){this.resetToInitialState();var e=this._dynamicObstacleSystem.getObstacles();console.log("🔄 重绘 ".concat(e.length," 個動態障礙物到GPU纹理"));for(var t=0,n=e;t<n.length;t++){var o=n[t];this.addObstacle(o.size,o.pos)}},t.prototype.resetToInitialState=function(){var t=e.prototype.gl.call(this);this._fbo.bind([this._texture]),t.clearColor(0,0,0,0),t.clear(t.COLOR_BUFFER_BIT);for(var n=this._width,o=this._height,r=[],i=0;i<o;++i)for(var a=0;a<n;++a)0===i?r.push.apply(r,[127,255,0,255]):i===o-1?r.push.apply(r,[127,0,0,255]):0===a?r.push.apply(r,[255,127,0,255]):a===n-1?r.push.apply(r,[0,127,0,255]):r.push.apply(r,[0,0,0,0]);var s=new Uint8Array(r);t.bindTexture(t.TEXTURE_2D,this._texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,n,o,0,t.RGBA,t.UNSIGNED_BYTE,s)},t.prototype.initObstaclesMap=function(){for(var t=e.prototype.gl.call(this),n=this._width,o=this._height,r=[],i=0;i<o;++i)for(var a=0;a<n;++a)0===i?r.push.apply(r,[127,255,0,255]):i===o-1?r.push.apply(r,[127,0,0,255]):0===a?r.push.apply(r,[255,127,0,255]):a===n-1?r.push.apply(r,[0,127,0,255]):r.push.apply(r,[127,127,0,255]);for(var s=new Uint8Array(r),l=[],c=0;c<2;++c){var u=t.createTexture();t.bindTexture(t.TEXTURE_2D,u),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,n,o,0,t.RGBA,t.UNSIGNED_BYTE,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),l.push(u)}t.bindTexture(t.TEXTURE_2D,null),this._texture=l[0],this._initTexture=l[1]},t.prototype.addDynamicObstacleVelocityToFluid=function(e){for(var t=0,n=this._dynamicObstacleSystem.getObstacles();t<n.length;t++){var o=n[t],r=1.5*Math.max(o.size[0],o.size[1]),i=[r,r],a=[.5*o.vel[0],.5*o.vel[1]];Math.sqrt(o.vel[0]*o.vel[0]+o.vel[1]*o.vel[1])>.001&&e.addVel(o.pos,i,a)}},t}(c.default);t.default=p},457:function(){},61:function(e,t,n){var o=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var r=Object.getOwnPropertyDescriptor(t,n);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,r)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),r=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)"default"!==n&&Object.prototype.hasOwnProperty.call(e,n)&&o(t,e,n);return r(t,e),t};Object.defineProperty(t,"__esModule",{value:!0}),t.fluid=t.obstacles=t.display=t.brush=t.bind=t.mouse=void 0;var a=i(n(761));n(457);var s=function(){function e(){var e=this;this._posInPx=[0,0],this._pivotInPx=[0,0],this.setPosInPx([0,0]),this.setMovementInPx([0,0]),Page.Canvas.Observers.mouseMove.push((function(t,n){var o=Page.Canvas.getSize();e.setPosInPx([o[0]*t,o[1]*(1-n)])})),Page.Canvas.Observers.mouseDown.push((function(){e.setMovementInPx([0,0]),e._pivotInPx=e._posInPx}))}return Object.defineProperty(e.prototype,"posInPx",{get:function(){return this._posInPx},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pos",{get:function(){return this._pos},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"movementInPx",{get:function(){return this._movementInPx},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"movement",{get:function(){return this._movement},enumerable:!1,configurable:!0}),e.prototype.setPosInPx=function(e){var t=[this._pivotInPx[0]-e[0],this._pivotInPx[1]-e[1]],n=Math.sqrt(t[0]*t[0]+t[1]*t[1]);n>16&&(t[0]*=16/n,t[1]*=16/n,this._pivotInPx[0]=e[0]+t[0],this._pivotInPx[1]=e[1]+t[1]);var o=[-t[0]/16,-t[1]/16];this.setMovementInPx(o),this._posInPx=e,this._pos=this.setRelative(e)},e.prototype.setMovementInPx=function(e){this._movementInPx=e,this._movement=this.setRelative(e)},e.prototype.setRelative=function(e){var t=Page.Canvas.getSize();return[e[0]/t[0],e[1]/t[1]]},e}(),l=new s;t.mouse=l;var c={radius:10,strength:100};t.brush=c;var u,d={stream:!0};t.fluid=d,function(e){e.NONE="none",e.ONE="one",e.MANY="many",e.DYNAMIC="dynamic"}(u||(u={}));var h=u.NONE;t.obstacles=h;var p={velocity:!0,pressure:!0,brush:!0,obstacles:!0};t.display=p,t.bind=function(e){!function(e){var n="resolution",o=function(t){var n=+t[0];e.reset(n,n)};Page.Tabs.addObserver(n,o),o(Page.Tabs.getValues(n));var r="float-texture-checkbox-id";a.allExtensionsLoaded||(Page.Controls.setVisibility(r,!1),Page.Checkbox.setChecked(r,!1));var i=function(t){e.useFloatTextures=t};Page.Checkbox.addObserver(r,i),i(Page.Checkbox.isChecked(r));var s="solver-steps-range-id",l=function(t){e.minNbIterations=t};Page.Range.addObserver(s,l),l(Page.Range.getValue(s));var u="timestep-range-id",v=function(t){e.timestep=t};Page.Range.addObserver(u,v),v(Page.Range.getValue(u));var f="stream-checkbox-id",b=function(e){d.stream=e};Page.Checkbox.addObserver(f,b),b(Page.Checkbox.isChecked(f));var _="obstacles",m=function(e){t.obstacles=h=e[0]};Page.Tabs.addObserver(_,m),m(Page.Tabs.getValues(_));var y="brush-radius-range-id",g=function(e){c.radius=e};Page.Range.addObserver(y,g),g(Page.Range.getValue(y)),Page.Canvas.Observers.mouseWheel.push((function(e){Page.Range.setValue(y,c.radius+5*e),g(Page.Range.getValue(y))}));var x="brush-strength-range-id",P=function(e){c.strength=e};Page.Range.addObserver(x,P),P(Page.Range.getValue(x));var O="displayed-fields",E=function(e){p.velocity="velocity"===e[0]||"velocity"===e[1],p.pressure="pressure"===e[0]||"pressure"===e[1]};Page.Tabs.addObserver(O,E),E(Page.Tabs.getValues(O));var T="intensity-range-id",S=function(t){e.colorIntensity=t};Page.Range.addObserver(T,S),S(Page.Range.getValue(T));var C="display-color-checkbox-id",D=function(t){e.color=t};Page.Checkbox.addObserver(C,D),D(Page.Checkbox.isChecked(C));var w="display-obstacles-checkbox-id",R=function(e){p.obstacles=e};Page.Checkbox.addObserver(w,R),R(Page.Checkbox.isChecked(w))}(e),t.mouse=l=new s}},761:function(e,t,n){Object.defineProperty(t,"__esModule",{value:!0}),t.allExtensionsLoaded=t.loadExtensions=t.check=void 0,n(457),t.check=function(e){return!(e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision<23&&(Page.Demopage.setErrorMessage("webgl-requirements","Your device only supports low precision float in fragment shader.\nThe simulation will not run."),1))};var o=!1;t.allExtensionsLoaded=o,t.loadExtensions=function(e,n){t.allExtensionsLoaded=o=!0;for(var r=0,i=0,a=n;i<a.length;i++){var s=a[i];e.getExtension(s)||(Page.Demopage.setErrorMessage("no-ext"+r,"Cannot load WebGL extension '"+s+"'."),t.allExtensionsLoaded=o=!1),++r}}},363:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.buildDrawShader=void 0;var r=o(n(490)),i=o(n(62)),a=new(n(445).ShaderSrc)("uniform vec2 uBrushSize; //relative, in [0,1]x[0,1]\nuniform vec2 uBrushPos; //relative, in [0,1]x[0,1]\n\nattribute vec2 aCorner; //in {-1,+1}x{-1,+1}\n\nvarying vec2 toCenter;\n\nvoid main(void) {\n    toCenter = -aCorner;\n\n    vec2 pos = uBrushPos + aCorner * uBrushSize;\n\n    gl_Position = vec4(2.0 * pos - 1.0, 0, 1);\n}","precision mediump float;\n\nuniform float uThickness; //relative to brushRadius\n\nvarying vec2 toCenter;\n\nvoid main(void) {\n    float dist = length(toCenter);\n    if (dist < 1.0-uThickness || dist > 1.0)\n        discard;\n\n    const vec3 color = vec3(1);\n\n    gl_FragColor = vec4(color, 1.0);\n}");t.buildDrawShader=function(e){var t=new r.default(e,a.vert,a.frag);return t.a.aCorner.VBO=i.default.createQuad(e,-1,-1,1,1),t}},445:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ShaderSrc=t.fetch=void 0,t.fetch=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(),t.responseText};var n=function(){function e(e,t){this.vert=e,this.frag=t}return e.prototype.batchReplace=function(e){for(var t=0,n=e;t<n.length;t++){var o=n[t];this.vert=this.vert.replace(new RegExp(o.toReplace),o.replacement),this.frag=this.frag.replace(new RegExp(o.toReplace),o.replacement)}},e.fromScript=function(t,n){return new e(document.getElementById(t).text,document.getElementById(n).text)},e}();t.ShaderSrc=n},916:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.setUseFloatTextures=t.buildObstaclesVelocityShader=t.buildSubstractGradientShader=t.buildDivergenceShader=t.buildJacobiPressureShader=t.buildAdvectShader=t.buildAddVelShader=t.buildDrawPressureShader=t.buildDrawVelocityShader=void 0;var r=o(n(490)),i=o(n(62)),a=n(445),s=n(170),l="const float MAX_SPEED = 1.0;\nconst float SPEED_BANDWIDTH = 2.01 * MAX_SPEED;\n\nconst float MIN_DIVERGENCE = -4.0 * MAX_SPEED;\nconst float MAX_DIVERGENCE =  4.0 * MAX_SPEED;\nconst float DIVERGENCE_BANDWIDTH = MAX_DIVERGENCE - MIN_DIVERGENCE;\n\nconst float MIN_PRESSURE = 0.5 * MIN_DIVERGENCE;\nconst float MAX_PRESSURE = 0.5 * MAX_DIVERGENCE;\nconst float PRESSURE_BANDWIDTH = MAX_PRESSURE - MIN_PRESSURE;\n\n/* Decodes a float value (32 bits in [0,1])\n * from a 4D value (4x8bits in [0,1]x[0,1]x[0,1]x[0,1]) */\nfloat decode32bit(vec4 v)\n{\n    const vec4 weights = 255.0 * vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0) / (256.0*256.0*256.0*256.0 - 1.0);\n    return dot(weights, v);\n}\n\n/* Encodes a float value (32 bits in [0,1])\n * into a 4D value (4x8bits in [0,1]x[0,1]x[0,1]x[0,1]) */\nvec4 encode32bit(float f)\n{\n    const vec4 base = (256.0*256.0*256.0*256.0 - 1.0) / vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\n    return floor(mod(f * base, 256.0)) / 255.0;\n}\n\n/* Decodes a float value (16 bits in [0,1])\n * from a 2D value (2x8bits in [0,1]x[0,1]) */\nfloat decode16bit(vec2 v)\n{\n    const vec2 weights = 255.0 * vec2(256.0, 1.0) / (256.0*256.0 - 1.0);\n    return dot(weights, v);\n}\n\n/* Encodes a float value (16 bits in [0,1])\n * into a 2D value (2x8bits in [0,1]x[0,1]) */\nvec2 encode16bit(float f)\n{\n    const vec2 base = (256.0*256.0 - 1.0) / vec2(256.0, 1.0);\n    return floor(mod(f * base, 256.0)) / 255.0;\n}\n\nfloat decodeDivergence(vec4 texel) {\n    float div = decode32bit(texel);\n    return div * DIVERGENCE_BANDWIDTH + MIN_DIVERGENCE;\n}\nvec4 encodeDivergence(float div) {\n    div = (div - MIN_DIVERGENCE) / DIVERGENCE_BANDWIDTH;\n    return encode32bit(div);\n}\n\nfloat decodePressure(vec4 texel) {\n    float p = decode32bit(texel);\n    return p * PRESSURE_BANDWIDTH + MIN_PRESSURE;\n}\nvec4 encodePressure(float p) {\n    p = (p - MIN_PRESSURE) / PRESSURE_BANDWIDTH;\n    return encode32bit(p);\n}\n\n___ENCODING_VELOCITY___\n\n___ENCODING_OBSTACLES___",c="attribute vec2 aCorner; //{0,1}x{0,1}\n\nvarying vec2 sampleCoords;\n\nvoid main(void) {\n    sampleCoords = aCorner;\n    gl_Position = vec4(2.0*aCorner - 1.0, 0.0, 1.0);\n}",u=l;function d(e){u=(u=l.replace(/___ENCODING_VELOCITY___/g,e?"vec4 encodeVelocity(vec2 vel) {\n    return vec4(vel, 0, 0);\n}\nvec2 decodeVelocity(vec4 texel) {\n    return texel.rg;\n}":"vec4 encodeVelocity(vec2 vel) {\n    vel = 0.5 * (vel / MAX_SPEED + 1.0);\n    return vec4(encode16bit(vel.x), encode16bit(vel.y));\n}\nvec2 decodeVelocity(vec4 texel) {\n    vec2 vel = vec2(decode16bit(texel.rg), decode16bit(texel.ba));\n    return (2.0 * vel - 1.0) * MAX_SPEED;\n}")).replace(/___ENCODING_OBSTACLES___/g,s.encodingStr)}d(!1),t.setUseFloatTextures=d;var h=new a.ShaderSrc(c,"precision mediump float;\n\nuniform sampler2D uVel;\nuniform float uColorIntensity;\nuniform bool uBlacknWhite;\n\nvarying vec2 sampleCoords;\n\n___ENCODING___\n\n/*\n   /---__/     __\n 0 1 2 3 4\n*/\nfloat bump(float x) {\n  return min(mix(0.0, 1.0, clamp(x, 0.0, 1.0)),\n             mix(1.0, 0.0, clamp(x-3.0, 0.0, 1.0)));\n}\n\n/* Every hue, periodic with a period of 1 */\nvec3 color(float value) {\n    value *= 6.0;\n    float r = bump(mod(value-4.0, 6.0));\n    float g = bump(mod(value-0.0, 6.0));\n    float b = bump(mod(value-2.0, 6.0));\n    return vec3(r,g,b);\n}\n\nvoid main(void) {\n    vec2 vel = decodeVelocity(texture2D(uVel, sampleCoords)) / MAX_SPEED;\n\n    vec3 c = color(atan(vel.y, vel.x) / (2.0 * 3.14159));\n    c = mix(c, vec3(1), float(uBlacknWhite));\n\n    float intensity = smoothstep(0.0, 1.0, uColorIntensity*length(vel));\n\n    gl_FragColor = vec4(intensity * c, 1);\n}"),p=new a.ShaderSrc(c,"precision mediump float;\n\nuniform sampler2D uPressure;\nuniform float uColorIntensity;\nuniform bool uBlacknWhite;\n\nvarying vec2 sampleCoords;\n\n___ENCODING___\n\nvec3 color(float value) {\n    value = smoothstep(0.0, 1.0, clamp(value, 0.0, 1.0));\n    value = smoothstep(0.0, 1.0, value);\n\n    float r = smoothstep(.5, .75, value);\n    float g = min(smoothstep(.0, .25, value),\n                  1.0 - smoothstep(.75, 1.0, value));\n    float b = 1.0 - smoothstep(.25, .5, value);\n    return vec3(r,g,b);\n}\n\nvoid main(void) {\n    float pressure = decodePressure(texture2D(uPressure, sampleCoords));\n    pressure = pressure / MAX_PRESSURE;\n    pressure = clamp(256.0*uColorIntensity*pressure, -.5, .5) + 0.5;\n\n    vec3 c = color(pressure);\n    c = mix(c, vec3(pressure), float(uBlacknWhite));\n\n    gl_FragColor = vec4(c, 1);\n}"),v=new a.ShaderSrc("uniform vec2 uBrushSize; //relative, in [0,1]x[0,1]\nuniform vec2 uBrushPos; //relative, in [0,1]x[0,1]\n\nattribute vec2 aCorner; //{0,1}x{0,1}\n\nvarying vec2 sampleCoords;\nvarying vec2 toBrush;\n\nvoid main(void) {\n    sampleCoords = aCorner;\n    toBrush = (uBrushPos - aCorner) / uBrushSize;\n\n    gl_Position = vec4(2.0*aCorner - 1.0, 0.0, 1.0);\n}","precision mediump float;\n\nuniform sampler2D uVel;\n\nuniform vec2 uAddVel;\n\nvarying vec2 sampleCoords;\nvarying vec2 toBrush;\n\n___ENCODING___\n\nvoid main(void) {\n    vec2 vel = decodeVelocity(texture2D(uVel, sampleCoords));\n\n    float influence = 1.0 - clamp(length(toBrush), 0.0, 1.0);\n    vec2 toAdd = influence * uAddVel;\n\n    vel += toAdd;\n    vel *= min(1.0, MAX_SPEED / length(vel));\n\n    gl_FragColor = encodeVelocity(vel);\n}"),f=new a.ShaderSrc(c,"precision mediump float;\n\nuniform sampler2D uQuantity; //thing to advect\nuniform sampler2D uVel;\n\nuniform vec2 uVelUnit;\nuniform float uDt;\n\nvarying vec2 sampleCoords;\n\n___ENCODING___\n\nvoid main(void) {\n    vec2 vel = decodeVelocity(texture2D(uVel, sampleCoords));\n    vec2 pos = sampleCoords - uDt * vel * uVelUnit;\n    gl_FragColor = texture2D(uQuantity, pos);\n}"),b=new a.ShaderSrc(c,"precision mediump float;\n\nuniform sampler2D uPrevIter; //x\nuniform sampler2D uConstantTerm; //b\nuniform sampler2D uObstacles;\n\nuniform float uAlpha;\nuniform float uInvBeta;\n\nuniform vec2 uTexelSize;\n\nvarying vec2 sampleCoords;\n\n___ENCODING___\n\nvoid main(void) {\n    vec2 obstacle = decodeObstacle(texture2D(uObstacles, sampleCoords));\n    vec2 coords = sampleCoords + uTexelSize * obstacle;\n\n    float result = decodePressure(texture2D(uPrevIter, coords - vec2(uTexelSize.x,0))) +\n                   decodePressure(texture2D(uPrevIter, coords + vec2(uTexelSize.x,0))) +\n                   decodePressure(texture2D(uPrevIter, coords - vec2(0,uTexelSize.y))) +\n                   decodePressure(texture2D(uPrevIter, coords + vec2(0,uTexelSize.y)));\n\n    result += uAlpha * decodeDivergence(texture2D(uConstantTerm, coords));\n    result *= uInvBeta;\n    result = clamp(result, MIN_PRESSURE, MAX_PRESSURE);\n\n    gl_FragColor = encodePressure(result);\n}"),_=new a.ShaderSrc(c,"precision mediump float;\n\nuniform sampler2D uVelocity;\n\nuniform vec2 uTexelSize;\n\nvarying vec2 sampleCoords;\n\n___ENCODING___\n\nvoid main(void) {\n    vec2 top =    decodeVelocity(texture2D(uVelocity, sampleCoords + vec2(0,uTexelSize.y)));\n    vec2 bottom = decodeVelocity(texture2D(uVelocity, sampleCoords - vec2(0,uTexelSize.y)));\n    vec2 left =   decodeVelocity(texture2D(uVelocity, sampleCoords - vec2(uTexelSize.x,0)));\n    vec2 right =  decodeVelocity(texture2D(uVelocity, sampleCoords + vec2(uTexelSize.x,0)));\n\n    float div = ((right.x - left.x) + (top.y - bottom.y));\n    div *= min(1.0, MAX_DIVERGENCE / length(div));\n\n    gl_FragColor = encodeDivergence(div);\n}"),m=new a.ShaderSrc(c,"precision mediump float;\n\nuniform sampler2D uVelocities;\nuniform sampler2D uPressure;\n\nuniform vec2 uTexelSize;\nuniform float uHalfInvDx;\n\nvarying vec2 sampleCoords;\n\n___ENCODING___\n\nvoid main(void) {\n    float top =    decodePressure(texture2D(uPressure, sampleCoords + vec2(0,uTexelSize.y)));\n    float bottom = decodePressure(texture2D(uPressure, sampleCoords - vec2(0,uTexelSize.y)));\n    float left =   decodePressure(texture2D(uPressure, sampleCoords - vec2(uTexelSize.x,0)));\n    float right =  decodePressure(texture2D(uPressure, sampleCoords + vec2(uTexelSize.x,0)));\n\n    vec2 grad = uHalfInvDx * vec2(right - left, top - bottom);\n\n    vec2 partialVel = decodeVelocity(texture2D(uVelocities, sampleCoords));\n    vec2 divFreeVel = partialVel - grad;\n    divFreeVel *= min(1.0, MAX_SPEED / length(divFreeVel));\n\n    gl_FragColor = encodeVelocity(divFreeVel);\n}"),y=new a.ShaderSrc(c,"precision mediump float;\n\nuniform sampler2D uVelocities;\nuniform sampler2D uObstacles;\n\nuniform vec2 uTexelSize;\n\nvarying vec2 sampleCoords;\n\n___ENCODING___\n\nvoid main(void) {\n    vec2 obstacle = decodeObstacle(texture2D(uObstacles, sampleCoords));\n    vec2 coords = sampleCoords + obstacle * uTexelSize;\n\n    vec2 vel = decodeVelocity(texture2D(uVelocities, coords));\n    vel *= sign(0.5 - dot(obstacle,obstacle));\n\n    gl_FragColor = encodeVelocity(vel);\n}");function g(e,t){var n=t.vert,o=t.frag.replace(/___ENCODING___/g,u),a=new r.default(e,n,o);return a.a.aCorner.VBO=i.default.createQuad(e,0,0,1,1),a}t.buildDrawVelocityShader=function(e){return g(e,h)},t.buildDrawPressureShader=function(e){return g(e,p)},t.buildAddVelShader=function(e){return g(e,v)},t.buildAdvectShader=function(e){return g(e,f)},t.buildJacobiPressureShader=function(e){return g(e,b)},t.buildDivergenceShader=function(e){return g(e,_)},t.buildSubstractGradientShader=function(e){return g(e,m)},t.buildObstaclesVelocityShader=function(e){return g(e,y)}},170:function(e,t,n){var o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),t.encodingStr=t.buildAddShader=t.buildDrawShader=void 0;var r=o(n(490)),i=o(n(62)),a=n(445),s="vec4 encodeObstacle(vec2 normal) {\n  normal = clamp(normalize(normal), -1.0, 1.0);\n  return vec4(0.5 * normal + 0.5, 0, 0);\n}\nvec2 decodeObstacle(vec4 texel) {\n  return 2.0 * texel.rg - 1.0;\n}";t.encodingStr=s;var l=[{toReplace:"___ENCODING___",replacement:s}],c=new a.ShaderSrc("attribute vec2 aCorner; //{0,1}x{0,1}\n\nvarying vec2 sampleCoords;\n\nvoid main(void) {\n    sampleCoords = aCorner;\n    gl_Position = vec4(2.0*aCorner - 1.0, 0.0, 1.0);\n}","precision mediump float;\n\nuniform sampler2D uObstacles;\n\nvarying vec2 sampleCoords;\n\n___ENCODING___\n\nvoid main(void) {\n    vec2 obstacle = decodeObstacle(texture2D(uObstacles, sampleCoords));\n    if (dot(obstacle, obstacle) < 0.5)\n        discard;\n\n    gl_FragColor = vec4(0.5*obstacle + 0.5, 0, 0);\n}");c.batchReplace(l);var u=new a.ShaderSrc("uniform vec2 uSize; //relative, in [0,1]x[0,1]\nuniform vec2 uPos; //relative, in [0,1]x[0,1]\n\nattribute vec2 aCorner; //in {-1,+1}x{-1,+1}\n\nvarying vec2 toCenter;\n\nvoid main(void) {\n    toCenter = -aCorner;\n\n    vec2 pos = uPos + aCorner * uSize;\n\n    gl_Position = vec4(2.0 * pos - 1.0, 0, 1);\n}","precision mediump float;\n\nvarying vec2 toCenter;\n\n___ENCODING___\n\nvoid main(void) {\n    float dist = length(toCenter);\n    if (dist > 1.0)\n        discard;\n\n    vec2 normal = -toCenter / dist;\n    gl_FragColor = encodeObstacle(normal);\n}");u.batchReplace(l),t.buildDrawShader=function(e){var t=new r.default(e,c.vert,c.frag);return t.a.aCorner.VBO=i.default.createQuad(e,0,0,1,1),t},t.buildAddShader=function(e){var t=new r.default(e,u.vert,u.frag);return t.a.aCorner.VBO=i.default.createQuad(e,-1,-1,1,1),t}},298:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.MultiMouseWS=t.CollisionDetector=void 0;var n=function(){function e(){}return e.checkPointObstacleCollision=function(e,t){var n=e.pos[0]-t.pos[0],o=e.pos[1]-t.pos[1];return Math.sqrt(n*n+o*o)<.01+.5*(t.size[0]+t.size[1])},e.handlePointObstacleCollision=function(e,t){var n=e.pos[0]-t.pos[0],o=e.pos[1]-t.pos[1],r=Math.sqrt(n*n+o*o);if(0!==r){var i=n/r,a=o/r,s=(e.movement[0]-t.vel[0])*i+(e.movement[1]-t.vel[1])*a;if(!(s>0)){console.log("💥 WS點碰撞! 點:[".concat(e.pos[0].toFixed(3),", ").concat(e.pos[1].toFixed(3),"] 障礙物ID:").concat(t.id," 路徑:").concat(r.toFixed(4)));var l=-(1+t.restitution)*s/(10+1/t.mass),c=l*i,u=l*a;t.vel[0]+=c/t.mass,t.vel[1]+=u/t.mass,console.log("⚡ 障礙物ID:".concat(t.id," 新速度:[").concat(t.vel[0].toFixed(3),", ").concat(t.vel[1].toFixed(3),"]"));var d=.01+.5*(t.size[0]+t.size[1])-r;if(d>0){var h=i*d*.5,p=a*d*.5;t.pos[0]-=h,t.pos[1]-=p}}}},e}();t.CollisionDetector=n;var o=function(){function e(e,t,n){void 0===n&&(n=10),this.url=e,this.points=[],this.onPointsUpdate=t,this.ws=null,this.isConnected=!1,this.fps=n,this.sendInterval=null}return e.prototype.connect=function(){var e=this;this.ws=new WebSocket(this.url),this.ws.onopen=function(){console.log("WS connected"),e.isConnected=!0,e.startSendLoop()},this.ws.onclose=function(){console.log("WS closed"),e.isConnected=!1,e.stopSendLoop()},this.ws.onerror=function(t){console.error("WS error",t),e.isConnected=!1},this.ws.onmessage=function(t){var n;try{var o=JSON.parse(t.data);Array.isArray(o)&&(void 0!==(null===(n=o[0])||void 0===n?void 0:n.pos)?e.points=o:e.points=o.map((function(e){return{pos:[e[0],e[1]],movement:[0,0]}})),e.performCollisionDetection(),e.onPointsUpdate&&e.onPointsUpdate(e.points))}catch(e){console.warn("Non-JSON message:",t.data)}}},e.prototype.performCollisionDetection=function(){var e=window.Parameters;if(e&&"dynamic"===e.obstacles){var t=window.dynamicObstacleController,o=window.obstacleMaps;if(t&&o&&o.dynamic){var r=o.dynamic.getDynamicObstacles();0!==r.length&&(this.points.forEach((function(e){r.forEach((function(t){n.checkPointObstacleCollision(e,t)&&(console.log("💥 碰撞檢測: 點[".concat(e.pos[0].toFixed(3),", ").concat(e.pos[1].toFixed(3),"] 與障礙物ID:").concat(t.id," 發生碰撞")),n.handlePointObstacleCollision(e,t))}))})),o.dynamic.redrawAllDynamicObstacles())}}},e.prototype.startSendLoop=function(){var e=this,t=1e3/this.fps;this.sendInterval=window.setInterval((function(){e.ws&&e.ws.readyState===WebSocket.OPEN&&e.ws.send("detect")}),t)},e.prototype.stopSendLoop=function(){null!==this.sendInterval&&(clearInterval(this.sendInterval),this.sendInterval=null)},e.prototype.disconnect=function(){this.stopSendLoop(),this.ws&&(this.ws.close(),this.ws=null),this.isConnected=!1},e.prototype.setFPS=function(e){this.fps=e,this.isConnected&&(this.stopSendLoop(),this.startSendLoop())},e}();t.MultiMouseWS=o}},t={};!function n(o){var r=t[o];if(void 0!==r)return r.exports;var i=t[o]={exports:{}};return e[o].call(i.exports,i,i.exports,n),i.exports}(633)}();
//# sourceMappingURL=main.min.js.map